# Build a marker gene reference set

## Problem description and objective 

GenBank uses Foosh pipelines to process new submissions of marker genes. An important component of these pipelines is a high quality database of reference gene sequences. Creating such a curated databases involves several manual steps.  The process starts with complicated Entrez queries.  The nucleotide/protein sequences are then manually evaluated using alignments and BLAST. Due to taxonomoic breadth this process is repeated several times to try and catch outliers and bad data. 

The goal of this project is to automate as many of these tasks as possible yet keep the process flexible enough for a curator to jump in at any step and review data. 

As a proof-of-concept, we will produce a Jupyter notebook that a curator can use to build a reference database for the gene CYTB that can be plugged into the GenBank Foosh pipeline. We chose CYTB for this because we can restrict the gene sequences to RefSeq database to keep the initial set relatively small, the gene does not have introns, and is similar to COX1 for which GenBank already has a foosh pipeline. 

## Workflow

The entire workflow can be executed from a Jupyter notebook with the ability to review and tweak parameters at almost each step. At the same time, the modular nature of the components allows one to wrap the entire workflow into a single script that can be executed without user intervention. 

Individual steps of the workflow are described below:

### 1. Fetch gene data 
```
input: query
output: bdbag archive, gene list
```
In this step, user provides an Entrez query to be used with the NCBI Gene database that will be used to obtain a list of all NCBI GeneIDs and a data archive containing sequence and metadata. 

### 2. Evaluate names
```
input: bdbag archive
output: gene names list
```
The bdbag archive returned by NCBI Datasets contains a data table that will be parsed to obtain a unique list of all gene symbols from the data. A tabular output showing the gene name and the number of sequences with that name allows the curator to quickly check for outliers in gene names. 

### 3. Evaluate sequence lengths
```
input: bdbag archive
output: summary statistics table
```
Sequence length information is extracted from the data table and a set of summary statistics are presented to the curator. Curator can then set parameters that will filter out any outliers. 
	
### 4. Bin sequences in to groups
```
input: bdbag archive, tax group identifiers
output: table with accessions
```
To keep the number of sequences used in the subsequent steps that involve all-vs-all BLAST analyses, sequences are grouped into broad taxonomic groups at the curator's discretion. This step accepts a list of NCBI taxonomy identifiers for various tax groups, parses the data table in the bdbag archive to extract all sequences that are part of a given taxonomic group. 

### 5. BLAST all 
```
input: bdbag archive, table with accessions
output: blast tabular output and blast alignments
```	
Using the list of sequence accessions produced by the previous step, a BLAST database will be built and all-vs-all BLAST is performed. A table with the BLAST results as well as alignments in ASN format will be returned. The BLAST table is used for assessing which set of parameters are to be used for the subsequent step of filtering sequences that will be kept for the reference BLAST database. The ASN file with all alignments can be loaded in to Gbech for visual inspection of all alignments. 
	
### 6. Filter BLAST results
```
input: BLAST TSV table, parameters for filtering and fasta file of all starting sequences
The notebook will run multiple analysis and output the results to the user. The actual pass/fail criteria can be modfied by the user for the specific data set. Additionally test criteria can also be added as needed. The list of accessions passing all tests can be output or used by Biopython to sort the fasta file. 
output: fasta file of all sequences that pass the filtering steps and a second fasta file of sequences that fail filtering.
```

	
### 7. Build a reference BLAST database
```
	input: bdbag archive, accession list
	output: blast database
```
In this final step, a blast database containing a reference set of sequences for a given gene is generated. A list of accessions generated by the previous step is used to determine which sequences are to be included in the database. 	

	
	
